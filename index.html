<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>样品移动端看板</title>
<style>
:root {
  --bg: #f5f5f7;
  --card: #ffffff;
  --border: #e5e5ea;
  --text: #1d1d1f;
  --muted: #6e6e73;
  --accent: #007aff;
  --in-stock-bg: #d1f0ff;
  --borrowed-bg: #ffe3e3;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI";
  background: var(--bg);
  color: var(--text);
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}

h1 {
  font-size: 28px;
  margin-bottom: 10px;
}

.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

input {
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  flex: 1 1 120px;
}

button {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  background: var(--accent);
  color: white;
  cursor: pointer;
}

button.secondary {
  background: #e5e5ea;
  color: var(--text);
}

.board {
  display: flex;
  gap: 20px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.column {
  flex: 1;
  min-width: 280px;
  background: #f0f0f0;
  border-radius: 12px;
  padding: 10px;
}

.column h2 {
  text-align: center;
  margin-bottom: 10px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  cursor: grab;
}

.in-stock { background: var(--in-stock-bg); }
.borrowed { background: var(--borrowed-bg); }

.card button {
  margin-top: 10px;
  width: 100%;
}

/* ------------------ 移动端自适应 ------------------ */
@media (max-width: 700px) {
  .board {
    flex-direction: column;
  }
}
</style>
</head>
<body>
<div class="container">
<h1>样品移动端看板</h1>

<div class="toolbar">
  <input id="sid" placeholder="样品编号">
  <input id="name" placeholder="样品名称">
  <input id="project" placeholder="项目">
  <input id="user_name" placeholder="使用人">
  <button onclick="submitSample()">入库</button>
  <button onclick="exportExcel()">导出 Excel</button>
</div>

<div class="board">
  <div class="column" id="in-stock-column">
    <h2>在库</h2>
  </div>
  <div class="column" id="borrowed-column">
    <h2>借出</h2>
  </div>
</div>
</div>

<!-- 库 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
/* ===================== 替换为你自己的 Supabase 项目信息 ===================== */
const SUPABASE_URL = "https://hglbfnfwvhqnpcpelvvl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnbGJmbmZ3dmhxbnBjcGVsdnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODMyNTAsImV4cCI6MjA4MjA1OTI1MH0.QHD-vPqfsIuWWrTFhGmoejrHhkSZkCu0MAsv6OT3WYo";
/* ============================================================================ */

const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------- 提交样品 ---------------- */
async function submitSample() {
  const data = {
    id: document.getElementById("sid").value,
    name: document.getElementById("name").value,
    project: document.getElementById("project").value,
    status: "in_stock",
    user_name: document.getElementById("user_name").value,
    updated_at: new Date()
  };

  const { error } = await client.from("current_samples").upsert(data);
  if (error) { alert("写入失败：" + error.message); return; }
  loadSamples();
}

/* ---------------- 借出 ---------------- */
async function borrow(id) {
  const user = prompt("借给谁？");
  if (!user) return;

  await client.from("current_samples")
    .update({ status: "borrowed", user_name: user, updated_at: new Date() })
    .eq("id", id);
  loadSamples();
}

/* ---------------- 归还 ---------------- */
async function returnSample(id) {
  await client.from("current_samples")
    .update({ status: "in_stock", user_name: null, updated_at: new Date() })
    .eq("id", id);
  loadSamples();
}

/* ---------------- 加载看板 ---------------- */
async function loadSamples() {
  const { data, error } = await client.from("current_samples").select("*").order("updated_at", { ascending: false });
  if (error) { console.error(error); return; }

  const inStockCol = document.getElementById("in-stock-column");
  const borrowedCol = document.getElementById("borrowed-column");
  inStockCol.innerHTML = "<h2>在库</h2>";
  borrowedCol.innerHTML = "<h2>借出</h2>";

  data.forEach(s => {
    const card = document.createElement("div");
    card.className = "card " + (s.status === "in_stock" ? "in-stock" : "borrowed");
    card.dataset.id = s.id;
    card.innerHTML = `
      <strong>${s.name}</strong><br>
      项目: ${s.project}<br>
      使用人: ${s.user_name || "-"}<br>
      <button onclick="${s.status==='in_stock'?`borrow('${s.id}')`:`returnSample('${s.id}')`}">
        ${s.status==='in_stock' ? "借出" : "归还"}
      </button>
    `;
    if (s.status === "in_stock") inStockCol.appendChild(card);
    else borrowedCol.appendChild(card);
  });

  /* ---------------- 拖拽 ---------------- */
  makeSortable("in-stock-column", "borrowed-column");
  makeSortable("borrowed-column", "in-stock-column");
}

/* ---------------- 拖拽函数 ---------------- */
function makeSortable(containerId, targetId) {
  const el = document.getElementById(containerId);
  if (!el.sortableInstance) {
    el.sortableInstance = new Sortable(el, {
      group: "shared",
      animation: 150,
      onAdd: async function(evt) {
        const id = evt.item.dataset.id;
        if (containerId === "in-stock-column") {
          // 拖入在库 = 归还
          await returnSample(id);
        } else {
          // 拖入借出
          const user = prompt("借给谁？");
          if (!user) { loadSamples(); return; }
          await client.from("current_samples")
            .update({ status: "borrowed", user_name: user, updated_at: new Date() })
            .eq("id", id);
          loadSamples();
        }
      }
    });
  }
}

/* ---------------- 实时刷新 ---------------- */
client.channel("samples-realtime")
  .on("postgres_changes", { event: "*", schema: "public", table: "current_samples" }, payload => {
    loadSamples();
  }).subscribe();

/* ---------------- 导出 Excel ---------------- */
async function exportExcel() {
  const { data, error } = await client.from("current_samples").select("*");
  if (error) { alert("导出失败"); return; }

  const sheet = XLSX.utils.json_to_sheet(
    data.map(d => ({
      样品编号: d.id,
      样品名称: d.name,
      项目: d.project,
      状态: d.status === "in_stock" ? "在库" : "借出",
      使用人: d.user_name || "",
      更新时间: new Date(d.updated_at).toLocaleString()
    }))
  );

  const book = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(book, sheet, "样品看板");
  XLSX.writeFile(book, "样品看板.xlsx");
}

/* ---------------- 初始化 ---------------- */
loadSamples();
</script>
</body>
</html>
